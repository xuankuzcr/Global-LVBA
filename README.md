# Global-LVBA
## Global LiDAR-Visual Bundle Adjustment

**Global-LVBA** is a globally consistent **LiDARâ€“Visual Bundle Adjustment** system for **refinement** after LiDAR-inertial-visual odometry (e.g., FAST-LIVO2).  
If you want to push accuracy to the next level, Global-LVBA further optimizes:
- point-cloud map consistency (reducing layering/stratification artifacts).
- camera poses towards **pixel-level reprojection accuracy**.

ðŸ“¬ For further assistance or inquiries, please feel free to contact Chunran Zheng at zhengcr@connect.hku.hk.

<p align="center">
  <img src="pics/lvba_cover.jpg" alt="Global-LVBA Cover" width="100%"/>
  <br/>
  <span style="color:#a0a0a0; font-size:13px;">
    This figure shows qualitative comparisons before and after Global-LVBA refinement from both texture and geometric-structure perspectives. The initial poses are provided by FAST-LIVO2.
  </span>
</p>

## 1. Prerequisites

### 1.1 Core Dependencies
- Python 3.8
- Ceres Solver 2.1.0
- Eigen 3.3.7
- OpenCV 4.2.0
- PCL (Point Cloud Library)

### 1.2 Visualization Module Dependencies
The built-in 3D visualizer requires the following additional libraries:

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y libglfw3-dev libsqlite3-dev libglew-dev

# The following are already included in thirdparty/:
# - GLAD (OpenGL loader)
# - ImGui (GUI library)
```

**Note:** If you encounter FFI-related linking errors (e.g., `ffi_closure_alloc`), install libffi:
```bash
sudo apt-get install -y libffi-dev
```

## 2. Build

```bash
cd catkin_ws/src/Global-LVBA
git submodule update --init --recursive
cd SiftGPU && mkdir build && cd build && cmake .. && make
cd catkin_ws && catkin_make
```
## 3. Dataset preparation 
    Global-LVBA/
    â””â”€â”€ dataset/
        â””â”€â”€ your_sequence_name/
            â”œâ”€â”€ all_image/
            â”‚   â”œâ”€â”€ 1661398632.022152.png     # image named by timestamp
            â”‚   â”œâ”€â”€ 1661398632.121881.png
            â”‚   â”œâ”€â”€ ...
            â”‚   â””â”€â”€ image_poses.txt           # camera poses (timestamp-aligned)
            â”œâ”€â”€ all_pcd_body/
            â”‚   â”œâ”€â”€ 1661398632.022152.pcd     # point cloud named by timestamp
            â”‚   â”œâ”€â”€ 1661398632.121881.pcd
            â”‚   â”œâ”€â”€ ...
            â”‚   â””â”€â”€ lidar_poses.txt           # LiDAR poses (timestamp-aligned)
            â”œâ”€â”€ colmap/
            â”‚   â”œâ”€â”€ match.db                  # feature matching database
            â”‚   â””â”€â”€ sparse/                   # optional: COLMAP output for 3DGS
            â”‚       â””â”€â”€ 0/
            â”‚           â”œâ”€â”€ images.txt
            â”‚           â””â”€â”€ points3D.txt
            â”œâ”€â”€ depth/                        # optional: generated depth maps
            â””â”€â”€ reproj/                       # optional: reprojection error logs

## 4. Run our examples
Download the example data from [LVBA-Dataset](https://pan.baidu.com/s/1SxTVGmDzJHnHL3muk-10eg?pwd=6666).
```bash
roslaunch Global-LVBA lvba.launch
```

ðŸ’¡ **Note 1:** In the FAST-LIVO2 config, set `pcd_save_en: false`, `type: 1`, and `img_save_en: true` to directly generate the required files for Global-LVBA.

ðŸ’¡ **Note 2:** We recommend using the `.db` file generated by **COLMAP** to obtain feature correspondences. The built-in SiftGPU extraction/matching in this repo is provided for convenience, but its matching quality is generally inferior to COLMAP.

## 5. 3D Visualization

After processing completes, a 3D visualizer window will automatically launch, allowing you to interactively explore the optimization results.

<p align="center">
  <img src="pics/imgui_visualizer.gif" alt="Global-LVBA Visulizer" width="100%"/>
  <br/>
  <span style="color:#a0a0a0; font-size:13px;">
    This figure shows a demo with imgui-based visualizer.
  </span>
</p>

### Visualization Modes
- **Before**: Point cloud before LiDAR BA optimization
- **After**: Point cloud after camera pose optimization (RGB colored)
- **Crossfade**: Alpha blend animation between Before and After
- **Morph**: Point movement animation showing LiDAR BA effect, then crossfade to final result

### Controls
| Input | Action |
|-------|--------|
| Left Mouse + Drag | Rotate view |
| Right Mouse + Drag | Pan view |
| Scroll Wheel | Zoom in/out |
| Space | Play/Pause animation |
| 1/2/3/4 | Switch cloud mode (Before/After/Crossfade/Morph) |
| C | Toggle color mode (RGB/JET height colormap) |
| P | Toggle point cloud visibility |
| T | Toggle trajectory visibility |
| G | Toggle grid visibility |
| R | Reset camera view |
| ESC | Close visualizer |

### Statistics Display
The ImGui panel shows:
- Reprojection error before/after optimization
- Convergence ratio
- Point cloud information

## 6. License

The source code of this package is released under the [**MIT**](https://opensource.org/license/mit) license.
